@page "/Resources/{resourceguid}/Book"
@page "/Resources/{resourceguid}/Book/{year:int}/{month:int}/{day:int}"
@using LSSD.Bookings

@code {

    [Inject]
    ResourceService _resourceService { get; set; }

    [Parameter]
    public string resourceguid { get; set; }

    [Parameter]
    public int year { get; set; } = DateTime.Today.Year;

    [Parameter]
    public int month { get; set; } = DateTime.Today.Month;

    [Parameter]
    public int day { get; set; } = DateTime.Today.Day;

    Resource selectedResource = null;
    List<SingleBooking> thisResourceBookings = new List<SingleBooking>();

    SingleBooking newBooking = new SingleBooking();

    protected override void OnInitialized()
    {

        if (resourceguid != null)
        {
            selectedResource = _resourceService.Get(resourceguid);
        }

        if (year == 0) {
            year = DateTime.Today.Year;
        }

        if (month == 0) {
            month = DateTime.Today.Month;
        }

        if (day == 0) {
            day = DateTime.Today.Day;
        }
    
        newBooking = new SingleBooking() {
            DurationMinutes = 450,
            StartHourUTC = 8,
            StartMinuteUTC = 0,
            BookingDate = new DateTime(year, month, day)
        };

        // Load bookings for this resource on this day


    }


    protected void HandleValidSubmit()
    {
        // Save the data
    }

    protected void HandleInValidSubmit()
    {
        // Do nothing
    }

}

@if(selectedResource == null) {
<p>Resource not found</p>
} else {
<h1>@selectedResource.Name</h1>
<p>
[<a href="/Resources/@(selectedResource.Id.ToString())">Back</a>]<br/>
</p>
<hr/>
<div class="daycalendar_day_container">
    <div class="daycalendar_day_newbooking_form">
        <h2>Create new booking</h2>
         <EditForm Model="newBooking" OnValidSubmit="@HandleValidSubmit" OnInvalidSubmit="@HandleInValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />
            
            <WebFrontend.Components.SingleBookingEditComponent Booking="@newBooking" BookableResource="@selectedResource" />
            <div class="form-group">
                <div class="form-row">
                    <div class="col">
                        <button type="submit" class="btn btn-primary btn-block">Create booking</button>
                    </div>
                </div>
            </div>
         </EditForm>
    </div>
    <div style="padding: 10px;">
        <h3>@(newBooking.BookingDate.ToString("dddd, MMMM dd, yyyy"))</h3>
        <div class="daycalendar_day">
        @for(int hour=6;hour<24;hour++) {
            <div class="daycalendar_hour_block">
                <div class="daycalendar_day_hour daycalendar_first_hour">
                    <div class="daycalendar_day_hour_label">@hour:00</div>
                </div>
                <div class="daycalendar_day_hour daycalendar_second_hour">
                    <div class="daycalendar_day_hour_label">@hour:30</div>
                </div>
                <div style="position: absolute; top: 0; left: 50px;">
                    @foreach(SingleBooking booking  in thisResourceBookings.Where(x => x.StartTimeUTC.Hour == @hour))
                    {
                        <div class="daycalendar_event" style="top: @((booking.StartTimeUTC.Minute/15)*13)px; height:@((booking.DurationMinutes/15)*13)px">
                            <b>@booking.ShortDescription</b><br/>
                            @(booking.StartTimeUTC.ToShortTimeString()) to @(booking.EndTimeUTC.ToShortTimeString())
                        </div>
                    }
                </div>
            </div>
        }
        </div>
    </div>
</div>
}